# Роль Ansible для установки и настройки NTP сервера

Эта роль устанавливает и настраивает NTP сервер (chrony или ntpd) на Linux хостах.

## Структура роли

```
ntp_server/
├── defaults/
│   └── main.yml       # Переменные по умолчанию
├── files/
│   └── chrony.conf    # Пример конфигурационного файла chrony
├── handlers/
│   └── main.yml       # Обработчики для перезагрузки службы
├── tasks/
│   └── main.yml       # Основные задачи
├── templates/
│   └── ntp.conf.j2    # Шаблон конфигурации ntpd
└── vars/
    └── main.yml       # Основные переменные
```

## Файлы роли

### defaults/main.yml

```yaml
---
# Выбор реализации NTP (chrony или ntpd)
ntp_implementation: "chrony"

# Настройки для chrony
chrony_config_file: "/etc/chrony.conf"
chrony_service_name: "chronyd"

# Настройки для ntpd
ntpd_config_file: "/etc/ntp.conf"
ntpd_service_name: "ntpd"

# Список NTP серверов для синхронизации
ntp_servers:
  - "0.pool.ntp.org"
  - "1.pool.ntp.org"
  - "2.pool.ntp.org"
  - "3.pool.ntp.org"

# Разрешить ли входящие NTP запросы (только для серверов)
ntp_allow_requests: false
ntp_allowed_networks: ["127.0.0.1", "::1"]

# Дополнительные настройки
ntp_timezone: "UTC"
```

### tasks/main.yml

```yaml
---
- name: Установка временной зоны
  timezone:
    name: "{{ ntp_timezone }}"

- name: Включение chrony (для систем на основе RHEL)
  block:
    - name: Установка chrony
      package:
        name: chrony
        state: present
    
    - name: Настройка chrony.conf
      template:
        src: chrony.conf.j2
        dest: "{{ chrony_config_file }}"
        owner: root
        group: root
        mode: 0644
      notify: restart chrony
    
    - name: Включение и запуск chrony
      service:
        name: "{{ chrony_service_name }}"
        state: started
        enabled: yes
  when: ntp_implementation == 'chrony'

- name: Включение ntpd (для систем, где chrony недоступен)
  block:
    - name: Установка ntpd
      package:
        name: ntp
        state: present
    
    - name: Настройка ntp.conf
      template:
        src: ntp.conf.j2
        dest: "{{ ntpd_config_file }}"
        owner: root
        group: root
        mode: 0644
      notify: restart ntpd
    
    - name: Включение и запуск ntpd
      service:
        name: "{{ ntpd_service_name }}"
        state: started
        enabled: yes
  when: ntp_implementation == 'ntpd'

- name: Проверка синхронизации времени
  command: "{{ ntp_implementation == 'chrony' and 'chronyc tracking' or 'ntpq -p' }}"
  register: ntp_status
  changed_when: false
  failed_when: false

- name: Показать статус синхронизации
  debug:
    var: ntp_status.stdout_lines
```

### handlers/main.yml

```yaml
---
- name: restart chrony
  service:
    name: "{{ chrony_service_name }}"
    state: restarted

- name: restart ntpd
  service:
    name: "{{ ntpd_service_name }}"
    state: restarted
```

### templates/chrony.conf.j2

```jinja2
# Ansible managed: Do NOT edit this file manually!

# Use public servers from the pool.ntp.org project.
{% for server in ntp_servers %}
server {{ server }} iburst
{% endfor %}

# Record the rate at which the system clock gains/losses time.
driftfile /var/lib/chrony/drift

# Allow the system clock to be stepped in the first three updates
# if its offset is larger than 1 second.
makestep 1.0 3

# Enable kernel synchronization of the real-time clock (RTC).
rtcsync

# Allow NTP client access from local network.
{% if ntp_allow_requests %}
{% for network in ntp_allowed_networks %}
allow {{ network }}
{% endfor %}
{% endif %}

# Serve time even if not synchronized to a time source.
local stratum 10

# Specify directory for log files.
logdir /var/log/chrony
```

### templates/ntp.conf.j2

```jinja2
# Ansible managed: Do NOT edit this file manually!

# Use public servers from the pool.ntp.org project.
{% for server in ntp_servers %}
server {{ server }} iburst
{% endfor %}

# Record the rate at which the system clock gains/losses time.
driftfile /var/lib/ntp/drift

# Permit time synchronization with our time source, but do not
# permit the source to query or modify the service on this system.
restrict default kod nomodify notrap nopeer noquery
restrict -6 default kod nomodify notrap nopeer noquery

# Permit all access over the loopback interface.
restrict 127.0.0.1
restrict -6 ::1

{% if ntp_allow_requests %}
# Allow NTP client access from local network.
{% for network in ntp_allowed_networks %}
restrict {{ network }} mask 255.255.255.255 nomodify notrap
{% endfor %}
{% endif %}
```

## Использование роли

1. Создайте playbook (например, `ntp_setup.yml`):

```yaml
---
- hosts: ntp_servers
  become: yes
  roles:
    - ntp_server
```

2. Запустите playbook:

```bash
ansible-playbook -i inventory ntp_setup.yml
```

## Переопределение переменных

Вы можете переопределить переменные при вызове роли:

```yaml
---
- hosts: ntp_servers
  become: yes
  vars:
    ntp_implementation: "ntpd"
    ntp_servers:
      - "0.ru.pool.ntp.org"
      - "1.ru.pool.ntp.org"
    ntp_allow_requests: true
    ntp_allowed_networks: ["192.168.1.0/24"]
  roles:
    - ntp_server
```

Эта роль поддерживает как chrony (рекомендуется для современных систем), так и традиционный ntpd, автоматически определяя, какой пакет нужно установить в зависимости от дистрибутива.