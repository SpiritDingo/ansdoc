–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Ansible —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–∞—Ö –ø–æ —Ñ–∏–ª—å—Ç—Ä—É, –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å package_facts –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∑–∞—Ç–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∏—Ö —Å –ø–æ–º–æ—â—å—é —É—Å–ª–æ–≤–∏–π Jinja2.

üéØ –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ–¥—Ö–æ–¥ –∫ —Å–æ–∑–¥–∞–Ω–∏—é —Ä–æ–ª–∏

–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å —Å –æ–¥–Ω–æ–π –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–¥–∞—á–µ–π –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.

1. –°–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤ —Ä–æ–ª–∏
   –°–æ–∑–¥–∞–π—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤ –¥–ª—è Ansible —Ä–æ–ª–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –∏–º–µ–Ω–µ–º package_info:
   ```
    roles/package_info/
    ‚îú‚îÄ‚îÄ tasks
    ‚îÇ   ‚îî‚îÄ‚îÄ main.yml
    ‚îî‚îÄ‚îÄ defaults
        ‚îî‚îÄ‚îÄ main.yml
   ```
2. –ó–∞–¥–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   –í —Ñ–∞–π–ª–µ defaults/main.yml –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞. –ü—É—Å—Ç–æ–π —Ñ–∏–ª—å—Ç—Ä –±—É–¥–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—å –≤—Å–µ –ø–∞–∫–µ—Ç—ã.
   ```yaml
    # defaults/main.yml
    package_filter: ""
   ```
3. –†–µ–∞–ª–∏–∑—É–π—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é –∑–∞–¥–∞—á—É
   –ü–æ–º–µ—Å—Ç–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥ –≤ —Ñ–∞–π–ª tasks/main.yml. –ó–∞–¥–∞—á–∞ —Å–Ω–∞—á–∞–ª–∞ —Å–æ–±–∏—Ä–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–∫–µ—Ç–∞—Ö, –∞ –∑–∞—Ç–µ–º –≤—ã–≤–æ–¥–∏—Ç —Ç–µ, —á—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ñ–∏–ª—å—Ç—Ä—É.
   ```yaml
    # tasks/main.yml
    - name: –°–æ–±—Ä–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–∞—Ö
      package_facts:
        manager: auto
      register: package_results  # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—ã–≤–æ–¥ –º–æ–¥—É–ª—è
   
    - name: "–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–∫–µ—Ç—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—É '{{ package_filter }}'"
      debug:
        msg: "–ü–∞–∫–µ—Ç: {{ item.key }}, –í–µ—Ä—Å–∏—è: {{ item.value[0].version }}"
      loop: "{{ ansible_facts.packages | dict2items }}"
      when: 
        - package_filter == "" or package_filter in item.key
        - item.value is defined
      loop_control:
        label: "{{ item.key }}"
   ```
   ¬∑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç: –ú–æ–¥—É–ª—å package_facts –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–±–æ –≤—Å–µ—Ö —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–∞—Ö –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é ansible_facts.packages. –í—Ç–æ—Ä–∞—è –∑–∞–¥–∞—á–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ —ç—Ç–æ–º—É —Å–ª–æ–≤–∞—Ä—é –∏ —Å –ø–æ–º–æ—â—å—é —É—Å–ª–æ–≤–∏—è when –≤—ã–≤–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ –ø–∞–∫–µ—Ç—ã, –∏–º—è –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫—É, —É–∫–∞–∑–∞–Ω–Ω—É—é –≤ package_filter. –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –ø—É—Å—Ç–æ–π, –≤—ã–≤–æ–¥—è—Ç—Å—è –≤—Å–µ –ø–∞–∫–µ—Ç—ã.

üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–æ–ª–∏ –≤ –ø–ª–µ–π–±—É–∫–µ

–°–æ–∑–¥–∞–π—Ç–µ –ø–ª–µ–π–±—É–∫, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≤–∞—à—É —Ä–æ–ª—å.

```yaml
# playbook.yml
- hosts: all  # –∏–ª–∏ –≤–∞—à–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞ —Ö–æ—Å—Ç–æ–≤
  roles:
    - role: package_info
      vars:
        package_filter: "python"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à—É —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø–æ–∏—Å–∫–∞
```

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–ª–µ–π–±—É–∫ –∫–æ–º–∞–Ω–¥–æ–π:

```bash
ansible-playbook playbook.yml
```

üõ†Ô∏è –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏ —É–ª—É—á—à–µ–Ω–∏—è

¬∑ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ set_fact –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π: –ï—Å–ª–∏ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –ø–ª–µ–π–±—É–∫–∞, –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é.
  ```yaml
    - name: "–°–æ–∑–¥–∞—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤"
      set_fact:
        filtered_packages: "{{ ansible_facts.packages | dict2items | selectattr('key', 'search', package_filter) | list }}"
      when: package_filter != ""
  
    - name: "–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫"
      debug:
        var: filtered_packages
      when: package_filter != ""
  ```
¬∑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–æ–º —Ñ–∞–∫—Ç–æ–≤: –î–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É.
  ```yaml
    - name: "–°–æ–±—Ä–∞—Ç—å package_facts, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ —Å–æ–±—Ä–∞–Ω—ã"
      package_facts:
        manager: auto
      register: package_results
      when: ansible_facts.packages is not defined
  ```

–≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –ª–µ–≥–∫–æ –ø–æ–ª—É—á–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–∞—Ö –Ω–∞ —É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö —É–∑–ª–∞—Ö. –î–ª—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ –≤–µ—Ä—Å–∏–∏ –∏–ª–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ) –≤—ã –º–æ–∂–µ—Ç–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–∏–µ when –≤ –∑–∞–¥–∞—á–µ, –æ–±—Ä–∞—â–∞—è—Å—å –∫ –¥—Ä—É–≥–∏–º –∞—Ç—Ä–∏–±—É—Ç–∞–º –æ–±—ä–µ–∫—Ç–∞ –ø–∞–∫–µ—Ç–∞, —Ç–∞–∫–∏–º –∫–∞–∫ item.value[0].version –∏–ª–∏ item.value[0].arch.